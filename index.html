<!DOCTYPE html>
<html lang="en">
<head>
<!-- =================================================================================================================== -->	
    <meta charset="utf-8"/>
    <title>[CMPT-276]: CHIP-8 Emulator</title>
    <link rel="stylesheet" href="emulator.css"> 
    <!-- =================================================================================================================== -->	

</head>

<body>
<!-- =================================================================================================================== -->	
<!--Title Display-->	
<div>
    <img src="Logo.png" alt="Team#16" width="100">
    <br><br>
    <font size= "5" style="color: rgb(0, 0, 0)"><marquee behavior= "Scroll" direction= "left"> Team #16 Presents: CHIP-8 Emulator</marquee></font>
</div>
<br>
<div id="wrapper">	
    <div class="buttonGroup">    
            <!--Buttons-->	
            <div>
                    <!--ROM Loading area-->
                <!--Idea: BROWSE through the computer's files for .ch8 files. NO DROP DOWN.-->
                <input id="rom" type="file" class="button"/> <!--Input Tag: Input Tag name: ROM.Input Type: file selection/usage-->
            </div>
            <div>
                <!--Buttons: Pause/Reset-->
                <button class="button" style="float:left" onclick="cpu.pause()">PLAY/PAUSE</button>
                <button class="button" style="float:left" onclick="resetScreen()">RESET</button>
                <button class="button" style="float:left" onclick="stepForward()">STEP FORWARD</button>
            </div>   
            <div>
                <!--Colour Picker-->
                <input type="color" style="float: right" class="button" id="colourPicker_BG" onchange="setPixelColour_BG()"> <!--No ending tag-->
                <input type="color"  class="button" id="colourPicker_FG" onchange="setPixelColour_FG()"> <!--No ending tag-->
            </div>
    </div>
    <br><br><br>
    
    <div style="align-content: center">
            <table id="registers">
                <tr>
                    <th id="reg0"></th>
                    <th id="reg1"></th>
                    <th id="reg2"></th>
                    <th id="reg3"></th>
                    <th id="reg4"></th>
                    <th id="reg5"></th>
                    <th id="reg6"></th>
                    <th id="reg7"></th>
                    <th id="reg8"></th>
                    <th id="reg9"></th>
                    <th id="reg10"></th>
                    <th id="reg11"></th>
                    <th id="reg12"></th>
                    <th id="reg13"></th>
                    <th id="reg14"></th>
                    <th id="reg15"></th>
                </tr>
                
            </table>
    </div>
    <br>
    
    <div id="mainContainer" style="align-content: center">
        <!--CHIP-8 Screen-->
        <canvas id="chipScreen" width="1280" height="640" style="border: 1px solid #353434"> </canvas><!--Register Box Area -->
        <br>
        
        <!--Memory Box Area -->
        <textarea id="memory" readonly></textarea>
    </div>
    

    <br><br><br><br><br>

</div> <!--DIV: Wrapper-->

<!-- =================================================================================================================== -->	
	
<!--Scripts-->
<script src = "Chip8.js"></script>
<script src = "visual.js"></script>
<script src = "RomLoader.js"></script>
<script>    
 
    // console.log("1234 & 0xf000: " + (1234 & 0xf000));
    var cpu = new CPU(); 
    var canv = document.getElementById("chipScreen");
    let SCALE = 20;
    var rend = new Renderer(canv, cpu.getHeight(), cpu.getWidth(), SCALE, 
                            document.getElementById("colourPicker_BG").value,
                            document.getElementById("colourPicker_FG").value);
    cpu.paused = true;
    cpu.randomizeMemory();
    cpu.setRenderer(rend);
    cpu.initRegisters();

   
</script> <!-- Primary CPU Activation and Display Testing (Manual) -->


<!-- =================================================================================================================== -->	
<!-- Memory box (: Will add more soon! -->
<script>
    let memo = document.getElementById("memory");
    let memArr = cpu.getMemory();


    var updateRegisters = function() {
        reg0.innerText  = "V0:\n" + cpu.getRegisterItem(0);
        reg1.innerText  = "V1:\n" + cpu.getRegisterItem(1);
        reg2.innerText  = "V2:\n" + cpu.getRegisterItem(2);
        reg3.innerText  = "V3:\n" + cpu.getRegisterItem(3);
        reg4.innerText  = "V4:\n" + cpu.getRegisterItem(4);
        reg5.innerText  = "V5:\n" + cpu.getRegisterItem(5);
        reg6.innerText  = "V6:\n" + cpu.getRegisterItem(6);
        reg7.innerText  = "V7:\n" + cpu.getRegisterItem(7);
        reg8.innerText  = "V8:\n" + cpu.getRegisterItem(8);
        reg9.innerText  = "V9:\n" + cpu.getRegisterItem(9);
        reg10.innerText = "VA:\n" + cpu.getRegisterItem(10);
        reg11.innerText = "VB:\n" + cpu.getRegisterItem(11);
        reg12.innerText = "VC:\n" + cpu.getRegisterItem(12);
        reg13.innerText = "VD:\n" + cpu.getRegisterItem(13);
        reg14.innerText = "VE:\n" + cpu.getRegisterItem(14);
        reg15.innerText = "VF:\n" + cpu.getRegisterItem(15);
    };    
    updateRegisters();
    

   let count = 0;
    
    setInterval(function() {
            try {
                if(cpu.hasROM && count < 200) {
                    cpu.cycle();
                    cpu.renderer.render(cpu.getDisplayArray());
                    let pc = cpu.getProgramCounter();
                    if(!cpu.paused || cpu.stepForward) {
                        if(cpu.stepForward) cpu.stepForward = false;
                        memo.textContent += "Opcode: " + cpu.getOpcode() + "\nPC: " + pc +"\n\n";
                        count++;
                    }
                    scrollToBottom();
                    updateRegisters();
                }
                else {
                    memo.innerText = "";
                    count = 0;
                }
                
            } catch (ex) {
                cpu.paused = true;
                throw ex;
            }
        },1); //1/1000 second

    //<!-- =================================================================================================================== -->	

    setInterval(function() {
        cpu.updateTimers();
    }, 2000 / 60); //60 times a second



    var setPixelColour_BG = function() {
        let clr = document.getElementById("colourPicker_BG").value;
        cpu.renderer.setPixelColour_BG(clr, cpu);
    };
    var setPixelColour_FG = function() {
        let clr = document.getElementById("colourPicker_FG").value;
        cpu.renderer.setPixelColour_FG(clr, cpu);
    };

    var stepForward = function() {
        if(cpu.paused === true) {
            cpu.stepForward = true; 
        }
    };

    var scrollToBottom = function() {
        let height = memo.getBoundingClientRect().height;
        if (Math.abs(memo.scrollHeight - memo.scrollTop - height) < 70) {
            memo.scrollTop = memo.scrollHeight - height;
        }
    };

    window.addEventListener('keydown', function (e){
          var key = e.keyCode;
          if (key === 80){
            cpu.pause();
          }
        });

    var resetScreen = function() {
        cpu.reset();
        memo.textContent = "";
    }
</script>
<!-- =================================================================================================================== -->	

<script>    
    var loadHexTest = function() {
        var testHex = [
            0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
            0x20, 0x60, 0x20, 0x20, 0x70, // 1
            0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
            0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
            0x90, 0x90, 0xF0, 0x10, 0x10, // 4
            0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
            0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
            0xF0, 0x10, 0x20, 0x40, 0x40, // 7
            0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
            0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
            0xF0, 0x90, 0xF0, 0x90, 0x90, // A
            0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
            0xF0, 0x80, 0x80, 0x80, 0xF0, // C
            0xE0, 0x90, 0x90, 0x90, 0xE0, // D
            0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
        0xF0, 0x80, 0xF0, 0x80, 0x80  // F
        ];

        // console.log(testHex[0].toString(16));//WORKS: GIVES YOU "FF"
        // var hexArr = [0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46, 0x00, 0x01, 0x01, 0x01, 0x00, 0x60];
        // var hexArr = [0x01];
        //Keep this for reference on later usages. To be used in future for other loaded arrays. To be turned into a function later. Visual/Chip8
        for (let i = 0, x = 0, y = 0; i < testHex.length / 5; i++, x++) {
            if (x >= 8) {
                y++;
                x = 0;
            }

            cpu.drawIntoDisplayArray(testHex.slice(i * 5, (i + 1) * 5), x * 6, y * 6, 5); // sprite, x, y, h
        }
    }
</script>

</body>

</html>
