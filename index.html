<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>[CMPT-276]: CHIP-8 Emulator</title>
    <link rel="stylesheet" href="emulator.css">
</head>
<body>

<div id="wrapper">
    
    <!--ROM Loading area-->
    <!--Idea: BROWSE through the computer's files for .ch8 files. NO DROP DOWN.-->
    <br><br><br>
    <input id="rom" type="file" /> <!-- Input Tag: Input Tag name: ROM.Input Type: file selection/usage -->
    <br><br>
    <canvas id="chipScreen" width="640" height="320" style="border: 2px solid black"> </canvas>
    <br><br>
    <center><button type="button" onclick="cpu.pause()">Play/Pause</button></center>
    <center><button type="button" onclick="resetScreen()">Reset</button></center>
    <br><br><br>

    <!--Memory Box Area -->
    <textarea id="memory"></textarea>
</div>

<!--Scripts-->
<script src = "Chip8.js"></script>
<script src = "visual.js"></script>
<script src = "RomLoader.js"></script>
<script>
    // console.log("1234 & 0xf000: " + (1234 & 0xf000));
    var cpu = new CPU();
    var canv = document.getElementById("chipScreen");
    var rend = new Renderer(canv, cpu.getHeight(), cpu.getWidth(), 10);

    cpu.paused = true;
    cpu.randomizeMemory();
    cpu.setRenderer(rend);
    cpu.initRegisters();
    // cpu.startup();

    var testHex = [
        0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
        0x20, 0x60, 0x20, 0x20, 0x70, // 1
        0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
        0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
        0x90, 0x90, 0xF0, 0x10, 0x10, // 4
        0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
        0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
        0xF0, 0x10, 0x20, 0x40, 0x40, // 7
        0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
        0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
        0xF0, 0x90, 0xF0, 0x90, 0x90, // A
        0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
        0xF0, 0x80, 0x80, 0x80, 0xF0, // C
        0xE0, 0x90, 0x90, 0x90, 0xE0, // D
        0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
        0xF0, 0x80, 0xF0, 0x80, 0x80  // F
    ];

    // console.log(testHex[0].toString(16));//WORKS: GIVES YOU "FF"
    // var hexArr = [0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46, 0x00, 0x01, 0x01, 0x01, 0x00, 0x60];
    // var hexArr = [0x01];
    //Keep this for reference on later usages. To be used in future for other loaded arrays. To be turned into a function later. Visual/Chip8
    for (let i = 0, x = 0, y = 0; i < testHex.length / 5; i++, x++) {
        if (x >= 8) {
            y++;
            x = 0;
        }

        cpu.drawIntoDisplayArray(testHex.slice(i * 5, (i + 1) * 5), x * 6, y * 6, 5); // sprite, x, y, h
    }
</script> <!-- Primary CPU Activation and Display Testing (Manual) -->


<!-- Memory box (: Will add more soon! -->
<script>
    var memo = document.getElementById("memory");
    var memArr = cpu.getMemory();

    // let idx = 0x200;
    setInterval(function() {
        if (cpu.paused) return;

        try {
            cpu.cycle();
            cpu.renderer.render(cpu.getDisplayArray());
            let pc = cpu.getProgramCounter();
            if (memArr[pc] > 0) {
                memo.textContent += "Opcode: " + cpu.getOpcode() + "\nPC: " + pc + "\nMemory: " + memArr[pc] + "\n\n";
            }
            scrollToBottom();
        } catch (ex) {
            cpu.paused = true;
            throw ex;
        }

        // idx++;
    },2); //1 second

    setInterval(function() {
        cpu.updateTimers();
    }, 2000 / 60); //60 times a second

    var scrollToBottom = function() {
        let height = memo.getBoundingClientRect().height;
        if (Math.abs(memo.scrollHeight - memo.scrollTop - height) < 80) {
            memo.scrollTop = memo.scrollHeight - height;
        }
    };

    window.addEventListener('keydown', function (e){
          var key = e.keyCode;
          if (key === 80){
            cpu.pause();
          }
        });

    var resetScreen = function() {
        cpu.reset();
        memo.textContent = "";
    }
</script>

<!-- <script>
	setInterval(function() {
		if(cpu.running === true) {
			console.log("FUCK");
			cpu.drawFlag = true;
			// cpu.cycle();

			if(cpu.drawFlag == true) {


				console.log("DRAW");
				cpu.drawOntoScreen();
			}
		}
	}, 2000); //2 seconds
</script> -->

</body>

</html>
